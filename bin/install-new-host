#!/bin/bash

if [ "$(id -u)" != "0" ]; then
    if [ -z "$SUDO_COMMAND" ]; then
        echo "This script must run as root, recalling self with sudo..."
        sudo $0 $*
        exit 0
    else
        echo "This script must run as root"
        exit 1
    fi
fi

# Inicial Update
apt update
apt upgrade

# For Docker:
apt install apt-transport-https ca-certificates curl gnupg2 \
    software-properties-common

curl -fsSL https://download.docker.com/linux/debian/gpg | \
    apt-key add -

add-apt-repository \
   "deb [arch=amd64] https://download.docker.com/linux/debian \
   $(lsb_release -cs) stable"

apt update
apt install docker-ce

# Install other packages
apt install $(< package-list.txt)

# Setup configs
cd /srv/data/host
stow -t / certbot
stow -t / zabbix
stow -t / apt

# Setup firewall
ufw allow 22/tcp
ufw allow proto tcp from any to any port 80,443
ufw allow from 172.18.0.250 to any port 10050
ufw allow from 50.249.20.86 to any port 10051
systemctl enable ufw
systemctl start ufw
